<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Email Validator v1.0</title>
    <!-- Bootstrap CSS -->
    <link
      href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/css/bootstrap.min.css"
      rel="stylesheet"
    />

    <style>
      @import url("https://fonts.googleapis.com/css2?family=Comfortaa:wght@300..700&display=swap");
      .main-body {
        font-family: "Comfortaa", sans-serif;
        background-color: #78bcc4;
        height: 100vh;
      }
      .container {
        background-color: #f7f8f3;
        position: absolute;
        top: 15%;
        border-radius: 10px;
        margin-left: 20%;
        margin-right: 20%;
        padding: 20px;
      }
      .custom-file-input::-webkit-file-upload-button {
        background-color: #002c3e;
        color: white;
        border-radius: 5px;
        border: none;
        padding: 5px 10px;
        cursor: pointer;
      }
      /* .form-control-file {
        background-color: #ff3b4e;
        border-radius: 5px;
        border: none;
      } */
      #fileInfo {
        width: 100%;
        height: 30%;
        border-radius: 10px;
      }
      .btn-primary {
        background-color: #002c3e;
        border-radius: 5px;
        border: none;
      }
      .btn-secondary {
        background-color: #f7444e;
        border-radius: 5px;
        border: none;
      }
    </style>
  </head>
  <body>
    <div class="main-body">
      <div class="container">
        <div class="form-group">
          <label for="modeSwitch">Switch to:</label>
          <div class="custom-control custom-switch">
            <input type="checkbox" class="custom-control-input" id="modeSwitch" />
            <label class="custom-control-label" for="modeSwitch">CSV</label>
          </div>
        </div>
        <form id="emailInputForm" method="post" onsubmit="handleSubmit(event)">
          <div id="emailInputField" class="form-group">
            <label for="emailInput">Email</label>
            <input
              type="text"
              class="form-control"
              id="emailInput"
              placeholder="email@example.com"
            />
          </div>
          <div id="csvInputField" class="form-group" style="display: none">
            <label for="csvFileInput">Browse File</label>
            <input type="file" class="form-control-file" id="csvFileInput" accept=".csv" />
            <br />
            <label for="selectedFileInfo">Selected File:</label>
            <div id="selectedFileInfo" class="border p-3">No file selected</div>
          </div>
          <div id="checkDeliverablilityField" class="form-group">
            <label for="deliverabilitySwitch">Check deliverability:</label>
            <div class="custom-control custom-switch">
              <input
                type="checkbox"
                class="custom-control-input"
                id="deliverabilitySwitch"
                checked
              />
              <label class="custom-control-label" for="deliverabilitySwitch">Yes</label>
            </div>
          </div>
          <button type="submit" class="btn btn-primary">Validate</button>
          <button type="reset" class="btn btn-secondary">Cancel</button>
        </form>
      </div>
    </div>
    <!-- Bootstrap JS and jQuery -->
    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/js/bootstrap.min.js"></script>
  </body>
  <!-- scripts -->
  <script id="toggleValidateButtonIfInputScript">
    var emailInput = document.getElementById("emailInput");
    var csvFileInput = document.getElementById("csvFileInput");
    var validateButton = document.querySelector('button[type="submit"]');
    var cancelButton = document.querySelector('button[type="reset"]');

    emailInput.addEventListener("input", toggleValidateButton);
    csvFileInput.addEventListener("change", toggleValidateButton);
    cancelButton.addEventListener("click", function () {
      // Delay the disable action to the next event loop after form fields are cleared
      setTimeout(toggleValidateButton, 0);
    });

    function toggleValidateButton() {
      var switchState = document.getElementById("modeSwitch").checked;
      if (switchState) {
        validateButton.disabled = !csvFileInput.value;
      } else {
        validateButton.disabled = !emailInput.value;
      }
    }

    // Call the function initially to set the button state
    toggleValidateButton();
  </script>
  <script id="formSubmitHandlerScript">
    async function handleSubmit(event) {
      event.preventDefault();
      let formData = new FormData(event.target);
      let modeSwitchState = document.getElementById("modeSwitch").checked;
      let deliverabilitySwitchState = document.getElementById("deliverabilitySwitch").checked;

      if (modeSwitchState) {
        let csvFileInput = document.getElementById("csvFileInput");
        if (csvFileInput.files.length > 0) {
          let file = csvFileInput.files[0];
          let text = await file.text();
          let emails = text.split("\r\n");
          console.log(emails);
          formData.append("payload_type", "emails");
          formData.append("emails", emails);
        }
      } else {
        let emailInput = document.getElementById("emailInput");
        formData.append("payload_type", "email");
        formData.append("email", emailInput.value);
      }
      if (deliverabilitySwitchState) {
        formData.append("checkDeliverability", true);
      } else {
        formData.append("checkDeliverability", false);
      }
      fetch("/validate-email", {
        method: "POST",
        body: formData,
      })
        .then((response) => response.text())
        .then((html) => {
          document.documentElement.innerHTML = html;
        })
        .catch((error) => {
          window.alert("An error occurred: " + error);
        });
      //   fetch("/validate-email", {
      //     method: "POST",
      //     body: formData,
      //   })
      //     .then((response) => {
      //       if (response.ok) {
      //         window.alert("Form data has been sent to the server");
      //         event.target.reset();
      //       } else {
      //         window.alert("An error occurred while sending the form data to the server");
      //       }
      //     })
      //     .catch((error) => {
      //       window.alert("An error occurred: " + error);
      //     });
    }
  </script>
  <script id="modeSwitchScript">
    var modeSwitch = document.getElementById("modeSwitch");
    var emailInputField = document.getElementById("emailInputField");
    var csvInputField = document.getElementById("csvInputField");
    modeSwitch.addEventListener("change", handleModeSwitchChange, false);
    function handleModeSwitchChange(e) {
      if (e.target.checked) {
        emailInputField.style.display = "none";
        csvInputField.style.display = "block";
      } else {
        emailInputField.style.display = "block";
        csvInputField.style.display = "none";
      }
    }
  </script>
  <script id="fileInputHandlerScript">
    var csvFileInput = document.getElementById("csvFileInput");
    var selectedFileInfo = document.getElementById("selectedFileInfo");
    csvFileInput.addEventListener("change", handleFileInput, false);
    function handleFileInput(e) {
      var file = e.target.files[0];
      var extension = file.name.split(".").pop().toLowerCase();
      if (
        (file.type === "text/csv" || file.type === "application/vnd.ms-excel") &&
        extension === "csv"
      ) {
        selectedFileInfo.textContent = file.name;
      } else {
        selectedFileInfo.textContent = "No file selected";
      }
    }
  </script>
</html>
